<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜æƒ åˆ¸APIæµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .coupons-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        .coupon-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
        }
        .coupon-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .coupon-actions {
            margin-top: 10px;
        }
        .coupon-actions button {
            font-size: 12px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BasaltPass ä¼˜æƒ åˆ¸ç®¡ç†APIæµ‹è¯•</h1>
        
        <div class="config">
            <h3>ğŸ”§ é…ç½®è®¾ç½®</h3>
            <div class="form-group">
                <label>APIåŸºç¡€URL:</label>
                <input type="text" id="baseUrl" value="http://localhost:8080">
            </div>
            <div class="form-group">
                <label>JWTä»¤ç‰Œ (å¯é€‰ - æµ‹è¯•æ—¶ç•™ç©º):</label>
                <input type="text" id="jwtToken" placeholder="ç•™ç©ºä½¿ç”¨æµ‹è¯•æ¨¡å¼">
            </div>
            <div class="form-group">
                <label>ç§Ÿæˆ·ID:</label>
                <input type="text" id="tenantId" value="1">
            </div>
        </div>

        <!-- å¥åº·æ£€æŸ¥ -->
        <div class="section">
            <h3>ğŸ” å¥åº·æ£€æŸ¥</h3>
            <button onclick="testHealth()">æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
            <div id="healthResponse" class="response" style="display:none;"></div>
        </div>

        <!-- è·å–ä¼˜æƒ åˆ¸åˆ—è¡¨ -->
        <div class="section">
            <h3>ğŸ“‹ ä¼˜æƒ åˆ¸åˆ—è¡¨</h3>
            <button onclick="loadCoupons()">è·å–æ‰€æœ‰ä¼˜æƒ åˆ¸</button>
            <div id="couponsResponse" class="response" style="display:none;"></div>
            <div id="couponsList" class="coupons-list"></div>
        </div>

        <!-- åˆ›å»ºä¼˜æƒ åˆ¸ -->
        <div class="section">
            <h3>â• åˆ›å»ºä¼˜æƒ åˆ¸</h3>
            <div class="form-group">
                <label>ä¼˜æƒ åˆ¸ä»£ç :</label>
                <input type="text" id="couponCode" value="TEST30" placeholder="ä¾‹: SAVE20">
            </div>
            <div class="form-group">
                <label>ä¼˜æƒ åˆ¸åç§°:</label>
                <input type="text" id="couponName" value="æµ‹è¯•ä¼˜æƒ åˆ¸30%æŠ˜æ‰£" placeholder="ä¼˜æƒ åˆ¸æ˜¾ç¤ºåç§°">
            </div>
            <div class="form-group">
                <label>æŠ˜æ‰£ç±»å‹:</label>
                <select id="discountType">
                    <option value="percent">ç™¾åˆ†æ¯”æŠ˜æ‰£</option>
                    <option value="amount">å›ºå®šé‡‘é¢</option>
                </select>
            </div>
            <div class="form-group">
                <label>æŠ˜æ‰£å€¼ (ç™¾åˆ†æ¯”ç”¨åŸºç‚¹ï¼Œå¦‚20%=2000):</label>
                <input type="number" id="discountValue" value="3000" placeholder="3000 (30%)">
            </div>
            <div class="form-group">
                <label>ä½¿ç”¨æœŸé™:</label>
                <select id="duration">
                    <option value="once">ä¸€æ¬¡æ€§</option>
                    <option value="repeating">é‡å¤ä½¿ç”¨</option>
                    <option value="forever">æ°¸ä¹…</option>
                </select>
            </div>
            <div class="form-group">
                <label>æœ€å¤§ä½¿ç”¨æ¬¡æ•°:</label>
                <input type="number" id="maxRedemptions" value="100">
            </div>
            <div class="form-group">
                <label>è¿‡æœŸæ—¶é—´:</label>
                <input type="datetime-local" id="expiresAt">
            </div>
            <button onclick="createCoupon()">åˆ›å»ºä¼˜æƒ åˆ¸</button>
            <div id="createResponse" class="response" style="display:none;"></div>
        </div>

        <!-- ä¼˜æƒ åˆ¸æ“ä½œ -->
        <div class="section">
            <h3>ğŸ”§ ä¼˜æƒ åˆ¸æ“ä½œ</h3>
            <div class="form-group">
                <label>ä¼˜æƒ åˆ¸ä»£ç :</label>
                <input type="text" id="operationCode" placeholder="è¾“å…¥è¦æ“ä½œçš„ä¼˜æƒ åˆ¸ä»£ç ">
            </div>
            <button onclick="getCoupon()">è·å–è¯¦æƒ…</button>
            <button onclick="validateCoupon()">éªŒè¯ä¼˜æƒ åˆ¸</button>
            <button onclick="toggleCouponStatus()">åˆ‡æ¢çŠ¶æ€</button>
            <button onclick="deleteCoupon()" class="danger">åˆ é™¤ä¼˜æƒ åˆ¸</button>
            <div id="operationResponse" class="response" style="display:none;"></div>
        </div>
    </div>

    <script>
        // è®¾ç½®é»˜è®¤è¿‡æœŸæ—¶é—´ä¸º30å¤©å
        document.addEventListener('DOMContentLoaded', function() {
            const expiresInput = document.getElementById('expiresAt');
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            expiresInput.value = defaultDate.toISOString().slice(0, 16);
        });

        // é€šç”¨APIè¯·æ±‚å‡½æ•°
        async function makeRequest(endpoint, method = 'GET', body = null) {
            const baseUrl = document.getElementById('baseUrl').value;
            const jwtToken = document.getElementById('jwtToken').value;
            const tenantId = document.getElementById('tenantId').value;

            const headers = {
                'Content-Type': 'application/json',
                'X-Tenant-ID': tenantId
            };

            if (jwtToken) {
                headers['Authorization'] = `Bearer ${jwtToken}`;
            }

            try {
                const response = await fetch(`${baseUrl}${endpoint}`, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch {
                    responseData = responseText;
                }

                return {
                    ok: response.ok,
                    status: response.status,
                    data: responseData
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: `ç½‘ç»œé”™è¯¯: ${error.message}`
                };
            }
        }

        // æ˜¾ç¤ºå“åº”ç»“æœ
        function showResponse(elementId, response) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `response ${response.ok ? 'success' : 'error'}`;
            element.textContent = `çŠ¶æ€: ${response.status}\n\n${JSON.stringify(response.data, null, 2)}`;
        }

        // å¥åº·æ£€æŸ¥
        async function testHealth() {
            const response = await makeRequest('/health');
            showResponse('healthResponse', response);
        }

        // è·å–ä¼˜æƒ åˆ¸åˆ—è¡¨
        async function loadCoupons() {
            const response = await makeRequest('/api/v1/admin/subscription/coupons');
            showResponse('couponsResponse', response);
            
            if (response.ok && response.data.coupons) {
                displayCoupons(response.data.coupons);
            }
        }

        // æ˜¾ç¤ºä¼˜æƒ åˆ¸åˆ—è¡¨
        function displayCoupons(coupons) {
            const container = document.getElementById('couponsList');
            container.innerHTML = '';

            coupons.forEach(coupon => {
                const couponDiv = document.createElement('div');
                couponDiv.className = 'coupon-item';
                
                const discountText = coupon.discount_type === 'percent' 
                    ? `${coupon.discount_value / 100}%`
                    : `Â¥${coupon.discount_value / 100}`;
                
                couponDiv.innerHTML = `
                    <h4>${coupon.code} - ${coupon.name}</h4>
                    <p><strong>æŠ˜æ‰£:</strong> ${discountText} (${coupon.discount_type})</p>
                    <p><strong>çŠ¶æ€:</strong> ${coupon.is_active ? 'âœ… æ¿€æ´»' : 'âŒ åœç”¨'}</p>
                    <p><strong>å·²ä½¿ç”¨:</strong> ${coupon.redemptions_count} / ${coupon.max_redemptions}</p>
                    <p><strong>è¿‡æœŸæ—¶é—´:</strong> ${new Date(coupon.expires_at).toLocaleString()}</p>
                    <div class="coupon-actions">
                        <button onclick="fillOperationCode('${coupon.code}')">é€‰æ‹©æ“ä½œ</button>
                        <button onclick="quickValidate('${coupon.code}')">å¿«é€ŸéªŒè¯</button>
                        <button onclick="quickToggle('${coupon.code}')" class="${coupon.is_active ? 'danger' : ''}">${coupon.is_active ? 'åœç”¨' : 'æ¿€æ´»'}</button>
                    </div>
                `;
                
                container.appendChild(couponDiv);
            });
        }

        // åˆ›å»ºä¼˜æƒ åˆ¸
        async function createCoupon() {
            const couponData = {
                code: document.getElementById('couponCode').value,
                name: document.getElementById('couponName').value,
                discount_type: document.getElementById('discountType').value,
                discount_value: parseInt(document.getElementById('discountValue').value),
                duration: document.getElementById('duration').value,
                max_redemptions: parseInt(document.getElementById('maxRedemptions').value),
                expires_at: new Date(document.getElementById('expiresAt').value).toISOString(),
                metadata: {
                    description: "é€šè¿‡æµ‹è¯•é¡µé¢åˆ›å»º",
                    created_by: "test_interface"
                }
            };

            const response = await makeRequest('/api/v1/admin/subscription/coupons', 'POST', couponData);
            showResponse('createResponse', response);
            
            if (response.ok) {
                // åˆ›å»ºæˆåŠŸååˆ·æ–°åˆ—è¡¨
                loadCoupons();
            }
        }

        // è·å–å•ä¸ªä¼˜æƒ åˆ¸
        async function getCoupon() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('è¯·è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç ');
                return;
            }
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`);
            showResponse('operationResponse', response);
        }

        // éªŒè¯ä¼˜æƒ åˆ¸
        async function validateCoupon() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('è¯·è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç ');
                return;
            }
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}/validate`);
            showResponse('operationResponse', response);
        }

        // åˆ‡æ¢ä¼˜æƒ åˆ¸çŠ¶æ€
        async function toggleCouponStatus() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('è¯·è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç ');
                return;
            }
            
            // å…ˆè·å–å½“å‰çŠ¶æ€
            const getResponse = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`);
            if (!getResponse.ok) {
                showResponse('operationResponse', getResponse);
                return;
            }
            
            const currentStatus = getResponse.data.coupon.is_active;
            const updateData = { is_active: !currentStatus };
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`, 'PUT', updateData);
            showResponse('operationResponse', response);
            
            if (response.ok) {
                loadCoupons(); // åˆ·æ–°åˆ—è¡¨
            }
        }

        // åˆ é™¤ä¼˜æƒ åˆ¸
        async function deleteCoupon() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('è¯·è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç ');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¼˜æƒ åˆ¸ "${code}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`, 'DELETE');
            showResponse('operationResponse', response);
            
            if (response.ok) {
                loadCoupons(); // åˆ·æ–°åˆ—è¡¨
                document.getElementById('operationCode').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šå¡«å……æ“ä½œä»£ç 
        function fillOperationCode(code) {
            document.getElementById('operationCode').value = code;
        }

        // è¾…åŠ©å‡½æ•°ï¼šå¿«é€ŸéªŒè¯
        async function quickValidate(code) {
            document.getElementById('operationCode').value = code;
            await validateCoupon();
        }

        // è¾…åŠ©å‡½æ•°ï¼šå¿«é€Ÿåˆ‡æ¢çŠ¶æ€
        async function quickToggle(code) {
            document.getElementById('operationCode').value = code;
            await toggleCouponStatus();
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½ä¼˜æƒ åˆ¸åˆ—è¡¨
        window.addEventListener('load', function() {
            setTimeout(() => {
                testHealth();
                loadCoupons();
            }, 500);
        });
    </script>
</body>
</html>
