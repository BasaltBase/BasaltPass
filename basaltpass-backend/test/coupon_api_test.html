<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>优惠券API测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .coupons-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        .coupon-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
        }
        .coupon-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .coupon-actions {
            margin-top: 10px;
        }
        .coupon-actions button {
            font-size: 12px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BasaltPass 优惠券管理API测试</h1>
        
        <div class="config">
            <h3>🔧 配置设置</h3>
            <div class="form-group">
                <label>API基础URL:</label>
                <input type="text" id="baseUrl" value="http://localhost:8080">
            </div>
            <div class="form-group">
                <label>JWT令牌 (可选 - 测试时留空):</label>
                <input type="text" id="jwtToken" placeholder="留空使用测试模式">
            </div>
            <div class="form-group">
                <label>租户ID:</label>
                <input type="text" id="tenantId" value="1">
            </div>
        </div>

        <!-- 健康检查 -->
        <div class="section">
            <h3>🔍 健康检查</h3>
            <button onclick="testHealth()">检查服务状态</button>
            <div id="healthResponse" class="response" style="display:none;"></div>
        </div>

        <!-- 获取优惠券列表 -->
        <div class="section">
            <h3>📋 优惠券列表</h3>
            <button onclick="loadCoupons()">获取所有优惠券</button>
            <div id="couponsResponse" class="response" style="display:none;"></div>
            <div id="couponsList" class="coupons-list"></div>
        </div>

        <!-- 创建优惠券 -->
        <div class="section">
            <h3>➕ 创建优惠券</h3>
            <div class="form-group">
                <label>优惠券代码:</label>
                <input type="text" id="couponCode" value="TEST30" placeholder="例: SAVE20">
            </div>
            <div class="form-group">
                <label>优惠券名称:</label>
                <input type="text" id="couponName" value="测试优惠券30%折扣" placeholder="优惠券显示名称">
            </div>
            <div class="form-group">
                <label>折扣类型:</label>
                <select id="discountType">
                    <option value="percent">百分比折扣</option>
                    <option value="amount">固定金额</option>
                </select>
            </div>
            <div class="form-group">
                <label>折扣值 (百分比用基点，如20%=2000):</label>
                <input type="number" id="discountValue" value="3000" placeholder="3000 (30%)">
            </div>
            <div class="form-group">
                <label>使用期限:</label>
                <select id="duration">
                    <option value="once">一次性</option>
                    <option value="repeating">重复使用</option>
                    <option value="forever">永久</option>
                </select>
            </div>
            <div class="form-group">
                <label>最大使用次数:</label>
                <input type="number" id="maxRedemptions" value="100">
            </div>
            <div class="form-group">
                <label>过期时间:</label>
                <input type="datetime-local" id="expiresAt">
            </div>
            <button onclick="createCoupon()">创建优惠券</button>
            <div id="createResponse" class="response" style="display:none;"></div>
        </div>

        <!-- 优惠券操作 -->
        <div class="section">
            <h3>🔧 优惠券操作</h3>
            <div class="form-group">
                <label>优惠券代码:</label>
                <input type="text" id="operationCode" placeholder="输入要操作的优惠券代码">
            </div>
            <button onclick="getCoupon()">获取详情</button>
            <button onclick="validateCoupon()">验证优惠券</button>
            <button onclick="toggleCouponStatus()">切换状态</button>
            <button onclick="deleteCoupon()" class="danger">删除优惠券</button>
            <div id="operationResponse" class="response" style="display:none;"></div>
        </div>
    </div>

    <script>
        // 设置默认过期时间为30天后
        document.addEventListener('DOMContentLoaded', function() {
            const expiresInput = document.getElementById('expiresAt');
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            expiresInput.value = defaultDate.toISOString().slice(0, 16);
        });

        // 通用API请求函数
        async function makeRequest(endpoint, method = 'GET', body = null) {
            const baseUrl = document.getElementById('baseUrl').value;
            const jwtToken = document.getElementById('jwtToken').value;
            const tenantId = document.getElementById('tenantId').value;

            const headers = {
                'Content-Type': 'application/json',
                'X-Tenant-ID': tenantId
            };

            if (jwtToken) {
                headers['Authorization'] = `Bearer ${jwtToken}`;
            }

            try {
                const response = await fetch(`${baseUrl}${endpoint}`, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });

                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch {
                    responseData = responseText;
                }

                return {
                    ok: response.ok,
                    status: response.status,
                    data: responseData
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: `网络错误: ${error.message}`
                };
            }
        }

        // 显示响应结果
        function showResponse(elementId, response) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `response ${response.ok ? 'success' : 'error'}`;
            element.textContent = `状态: ${response.status}\n\n${JSON.stringify(response.data, null, 2)}`;
        }

        // 健康检查
        async function testHealth() {
            const response = await makeRequest('/health');
            showResponse('healthResponse', response);
        }

        // 获取优惠券列表
        async function loadCoupons() {
            const response = await makeRequest('/api/v1/admin/subscription/coupons');
            showResponse('couponsResponse', response);
            
            if (response.ok && response.data.coupons) {
                displayCoupons(response.data.coupons);
            }
        }

        // 显示优惠券列表
        function displayCoupons(coupons) {
            const container = document.getElementById('couponsList');
            container.innerHTML = '';

            coupons.forEach(coupon => {
                const couponDiv = document.createElement('div');
                couponDiv.className = 'coupon-item';
                
                const discountText = coupon.discount_type === 'percent' 
                    ? `${coupon.discount_value / 100}%`
                    : `¥${coupon.discount_value / 100}`;
                
                couponDiv.innerHTML = `
                    <h4>${coupon.code} - ${coupon.name}</h4>
                    <p><strong>折扣:</strong> ${discountText} (${coupon.discount_type})</p>
                    <p><strong>状态:</strong> ${coupon.is_active ? '✅ 激活' : '❌ 停用'}</p>
                    <p><strong>已使用:</strong> ${coupon.redemptions_count} / ${coupon.max_redemptions}</p>
                    <p><strong>过期时间:</strong> ${new Date(coupon.expires_at).toLocaleString()}</p>
                    <div class="coupon-actions">
                        <button onclick="fillOperationCode('${coupon.code}')">选择操作</button>
                        <button onclick="quickValidate('${coupon.code}')">快速验证</button>
                        <button onclick="quickToggle('${coupon.code}')" class="${coupon.is_active ? 'danger' : ''}">${coupon.is_active ? '停用' : '激活'}</button>
                    </div>
                `;
                
                container.appendChild(couponDiv);
            });
        }

        // 创建优惠券
        async function createCoupon() {
            const couponData = {
                code: document.getElementById('couponCode').value,
                name: document.getElementById('couponName').value,
                discount_type: document.getElementById('discountType').value,
                discount_value: parseInt(document.getElementById('discountValue').value),
                duration: document.getElementById('duration').value,
                max_redemptions: parseInt(document.getElementById('maxRedemptions').value),
                expires_at: new Date(document.getElementById('expiresAt').value).toISOString(),
                metadata: {
                    description: "通过测试页面创建",
                    created_by: "test_interface"
                }
            };

            const response = await makeRequest('/api/v1/admin/subscription/coupons', 'POST', couponData);
            showResponse('createResponse', response);
            
            if (response.ok) {
                // 创建成功后刷新列表
                loadCoupons();
            }
        }

        // 获取单个优惠券
        async function getCoupon() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('请输入优惠券代码');
                return;
            }
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`);
            showResponse('operationResponse', response);
        }

        // 验证优惠券
        async function validateCoupon() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('请输入优惠券代码');
                return;
            }
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}/validate`);
            showResponse('operationResponse', response);
        }

        // 切换优惠券状态
        async function toggleCouponStatus() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('请输入优惠券代码');
                return;
            }
            
            // 先获取当前状态
            const getResponse = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`);
            if (!getResponse.ok) {
                showResponse('operationResponse', getResponse);
                return;
            }
            
            const currentStatus = getResponse.data.coupon.is_active;
            const updateData = { is_active: !currentStatus };
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`, 'PUT', updateData);
            showResponse('operationResponse', response);
            
            if (response.ok) {
                loadCoupons(); // 刷新列表
            }
        }

        // 删除优惠券
        async function deleteCoupon() {
            const code = document.getElementById('operationCode').value;
            if (!code) {
                alert('请输入优惠券代码');
                return;
            }
            
            if (!confirm(`确定要删除优惠券 "${code}" 吗？此操作不可恢复！`)) {
                return;
            }
            
            const response = await makeRequest(`/api/v1/admin/subscription/coupons/${code}`, 'DELETE');
            showResponse('operationResponse', response);
            
            if (response.ok) {
                loadCoupons(); // 刷新列表
                document.getElementById('operationCode').value = ''; // 清空输入框
            }
        }

        // 辅助函数：填充操作代码
        function fillOperationCode(code) {
            document.getElementById('operationCode').value = code;
        }

        // 辅助函数：快速验证
        async function quickValidate(code) {
            document.getElementById('operationCode').value = code;
            await validateCoupon();
        }

        // 辅助函数：快速切换状态
        async function quickToggle(code) {
            document.getElementById('operationCode').value = code;
            await toggleCouponStatus();
        }

        // 页面加载完成后自动加载优惠券列表
        window.addEventListener('load', function() {
            setTimeout(() => {
                testHealth();
                loadCoupons();
            }, 500);
        });
    </script>
</body>
</html>
